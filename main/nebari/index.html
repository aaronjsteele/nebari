<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="This crate provides the `Roots` type, which is the transactional storage layer for `BonsaiDb`. It is loosely inspired by `Couchstore`."><meta name="keywords" content="rust, rustlang, rust-lang, nebari"><title>nebari - Rust</title><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../light.css"  id="themeStyle"><link rel="stylesheet" type="text/css" href="../dark.css" disabled ><link rel="stylesheet" type="text/css" href="../ayu.css" disabled ><script id="default-settings" ></script><script src="../storage.js"></script><script src="../crates.js"></script><noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../favicon.svg"><style type="text/css">#crate-search{background-image:url("../down-arrow.svg");}</style></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu" role="button">&#9776;</div><a href='../nebari/index.html'><div class='logo-container rust-logo'><img src='../rust-logo.png' alt='logo'></div></a><h2 class="location">Crate nebari</h2><div class="block version"><div class="narrow-helper"></div><p>Version 0.1.1</p></div><div class="sidebar-elems"><a id="all-types" href="all.html"><p>See all nebari's items</p></a><div class="block items"><ul><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#traits">Traits</a></li></ul></div><div id="sidebar-vars" data-name="nebari" data-ty="mod" data-relpath=""></div><script defer src="sidebar-items.js"></script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="18" height="18" alt="Pick another theme!" src="../brush.svg"></button><div id="theme-choices" role="menu"></div></div><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../settings.html" title="settings"><img width="18" height="18" alt="Change settings" src="../wheel.svg"></a></div></form></nav><section id="main" class="content"><h1 class="fqn"><span class="in-band">Crate <a class="mod" href="#">nebari</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span><span class="out-of-band"><span id="render-detail"><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span><a class="srclink" href="../src/nebari/lib.rs.html#1-43" title="goto source code">[src]</a></span></h1><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>This crate provides the <code>Roots</code> type, which is the transactional storage layer
for <a href="https://dev.bonsaidb.io/"><code>BonsaiDb</code></a>. It is loosely inspired by
<a href="https://github.com/couchbase/couchstore"><code>Couchstore</code></a>.</p>
<p>This crate is alpha. While its format is considered stable, there may be bugs
that could lead to data loss. Please have a good backup strategy while using
this crate.</p>
<h3 id="examples" class="section-header"><a href="#examples">Examples</a></h3>
<p>Inserting a key-value pair in an on-disk tree with full revision history:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">nebari</span>::{
    <span class="ident">io::fs::StdFile</span>,
    <span class="ident">tree</span>::{<span class="ident">Root</span>, <span class="ident">Versioned</span>},
    <span class="ident">Config</span>,
};

<span class="kw">let</span> <span class="ident">database_folder</span> <span class="op">=</span> <span class="ident">tempfile::tempdir</span>().<span class="ident">unwrap</span>();
<span class="kw">let</span> <span class="ident">roots</span> <span class="op">=</span> <span class="ident">Config</span>::<span class="op">&lt;</span><span class="ident">StdFile</span><span class="op">&gt;</span><span class="ident">::default_for</span>(<span class="ident">database_folder</span>.<span class="ident">path</span>())
    .<span class="ident">open</span>()
    .<span class="ident">unwrap</span>();
<span class="kw">let</span> <span class="ident">tree</span> <span class="op">=</span> <span class="ident">roots</span>.<span class="ident">tree</span>(<span class="ident">Versioned::tree</span>(<span class="string">&quot;a-tree&quot;</span>)).<span class="ident">unwrap</span>();
<span class="ident">tree</span>.<span class="ident">set</span>(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>).<span class="ident">unwrap</span>();</code></pre></div>
<p>For more examples, check out <a href="https://github.com/khonsulabs/nebari/tree/main/nebari/examples/"><code>nebari/examples/</code></a>.</p>
<h3 id="features" class="section-header"><a href="#features">Features</a></h3>
<p>Nebari exposes multiple levels of functionality. The lowest level functionality
is the
<a href="https://nebari.bonsaidb.io/main/nebari/tree/struct.TreeFile.html"><code>TreeFile</code></a>.
A <code>TreeFile</code> is a key-value store that uses an append-only file format for its
implementation.</p>
<p>Using <code>TreeFile</code>s and a transaction log,
<a href="https://nebari.bonsaidb.io/main/nebari/struct.Roots.html"><code>Roots</code></a> enables
ACID-compliant, multi-tree transactions.</p>
<p>Each tree supports:</p>
<ul>
<li><strong>Key-value storage</strong>: Keys can be any arbitrary byte sequence up to 65,535
bytes long. For efficiency, keys should be kept to smaller lengths. Values can
be up to 4 gigabytes (2^32 bytes) in size.</li>
<li><strong>Flexible query options</strong>: Fetch records one key at a time, multiple keys at
once, or ranges of keys.</li>
<li><strong>Powerful multi-key operations</strong>: Internally, all functions that alter the
data in a tree use
<a href="https://nebari.bonsaidb.io/main/nebari/tree/struct.TreeFile.html#method.modify"><code>TreeFile::modify()</code></a>
which allows operating on one or more keys and performing <a href="https://nebari.bonsaidb.io/main/nebari/tree/enum.Operation.html">various
operations</a>.</li>
<li><strong>Pluggable low-level modifications</strong>: The <a href="https://nebari.bonsaidb.io/main/nebari/trait.Vault.html"><code>Vault</code>
trait</a> allows you to
bring your own encryption, compression, or other functionality to this format.
Each independently-addressible chunk of data that is written to the file
passes through the vault.</li>
<li><strong>Optional full revision history</strong>. If you don’t want to lose old revisions of
data, you can use a
<a href="https://nebari.bonsaidb.io/main/nebari/tree/struct.VersionedTreeRoot.html"><code>VersionedTreeRoot</code></a>
to store information that allows scanning old revision information. Or, if you
want to avoid the extra IO, use the
<a href="https://nebari.bonsaidb.io/main/nebari/tree/struct.UnversionedTreeRoot.html"><code>UnversionedTreeRoot</code></a>
which only stores the information needed to retrieve the latest data in the
file.</li>
<li><strong><a href="https://en.wikipedia.org/wiki/ACID">ACID</a>-compliance</strong>:
<ul>
<li>
<p><strong>Atomicity</strong>: Every operation on a <code>TreeFile</code> is done atomically.
<a href="https://nebari.bonsaidb.io/main/nebari/tree/enum.Operation.html#variant.CompareSwap"><code>Operation::CompareSwap</code></a>
can be used to perform atomic operations that require evaluating the
currently stored value.</p>
</li>
<li>
<p><strong>Consistency</strong>: Atomic locking operations are used when publishing a new
transaction state. This ensures that readers can never operate on a partially
updated state.</p>
</li>
<li>
<p><strong>Isolation</strong>: Currently, each tree can only be accessed exclusively within
a transaction. This means that if two transactions request the same tree,
one will execute and complete before the second is allowed access to the
tree. This strategy could be modified in the future to allow for more
flexibility.</p>
</li>
<li>
<p><strong>Durability</strong>: The append-only file format is designed to only allow
reading data that has been fully flushed to disk. Any writes that were
interrupted will be truncated from the end of the file.</p>
<p>Transaction IDs are recorded in the tree headers. When restoring from disk,
the transaction IDs are verified with the transaction log. Because of the
append-only format, if we encounter a transaction that wasn’t recorded, we
can continue scanning the file to recover the previous state. We do this
until we find a successfluly commited transaction.</p>
<p>This process is much simpler than most database implementations due to the
simple guarantees that append-only formats provide.</p>
</li>
</ul>
</li>
</ul>
<h4 id="why-use-an-append-only-file-format" class="section-header"><a href="#why-use-an-append-only-file-format">Why use an append-only file format?</a></h4>
<p><a href="https://github.com/ecton">@ecton</a> wasn’t a database engineer before starting
this project, and depending on your viewpoint may still not be considered a
database engineer. Implementing ACID-compliance is not something that should be
attempted lightly.</p>
<p>Creating ACID-compliance with append-only formats is much easier to achieve,
however, as long as you can guarantee two things:</p>
<ul>
<li>When opening a previously existing file, can you identify where the last valid
write occurred?</li>
<li>When writing the file, do not report that a transaction has succeeded until
the file is fully flushed to disk.</li>
</ul>
<p>The B-Tree implementation in Nebari is designed to offer those exact guarantees.</p>
<p>The major downside of append-only formats is that deleted data isn’t cleaned up
until a maintenance process occurs: compaction. This process rewrites the files
contents, skipping over entries that are no longer alive. This process can
happen without blocking the file from being operated on, but it does
introduce IO overhead during the operation.</p>
<p>Nebari provides APIs that perform compaction, but currently delegates scheduling
and automation to consumers of this library.</p>
<h3 id="open-source-licenses" class="section-header"><a href="#open-source-licenses">Open-source Licenses</a></h3>
<p>This project, like all projects from <a href="https://khonsulabs.com/">Khonsu Labs</a>, are
open-source. This repository is available under the <a href="./LICENSE-MIT">MIT License</a>
or the <a href="./LICENSE-APACHE">Apache License 2.0</a>.</p>
<p>To learn more about contributing, please see <a href="./CONTRIBUTING.md">CONTRIBUTING.md</a>.</p>
</div></details><h2 id="modules" class="section-header"><a href="#modules">Modules</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="mod" href="io/index.html" title="nebari::io mod">io</a></div><div class="item-right docblock-short"><p>IO abstractions for Nebari.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="mod" href="transaction/index.html" title="nebari::transaction mod">transaction</a></div><div class="item-right docblock-short"><p>ACID-compliant transaction log and manager.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="mod" href="tree/index.html" title="nebari::tree mod">tree</a></div><div class="item-right docblock-short"><p>Append-only B-Tree implementation</p>
</div></div></div><h2 id="structs" class="section-header"><a href="#structs">Structs</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Buffer.html" title="nebari::Buffer struct">Buffer</a></div><div class="item-right docblock-short"><p>A wrapper around a <code>Cow&lt;'a, [u8]&gt;</code> wrapper that implements Read, and has a
convenience method to take a slice of bytes as another Buffer which shares a
reference to the same underlying <code>Cow</code>.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.ChunkCache.html" title="nebari::ChunkCache struct">ChunkCache</a></div><div class="item-right docblock-short"><p>A configurable cache that operates at the “chunk” level.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Config.html" title="nebari::Config struct">Config</a></div><div class="item-right docblock-short"><p>A database configuration used to open a database.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Context.html" title="nebari::Context struct">Context</a></div><div class="item-right docblock-short"><p>A shared environment for database operations.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Error.html" title="nebari::Error struct">Error</a></div><div class="item-right docblock-short"><p>An error from Nebari as well as an associated backtrace.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.ExecutingTransaction.html" title="nebari::ExecutingTransaction struct">ExecutingTransaction</a></div><div class="item-right docblock-short"><p>An executing transaction. While this exists, no other transactions can
execute across the same trees as this transaction holds.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Roots.html" title="nebari::Roots struct">Roots</a></div><div class="item-right docblock-short"><p>A multi-tree transactional B-Tree database.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.ThreadPool.html" title="nebari::ThreadPool struct">ThreadPool</a></div><div class="item-right docblock-short"><p>A thread pool that commits transactions to disk in parallel.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.TransactionTree.html" title="nebari::TransactionTree struct">TransactionTree</a></div><div class="item-right docblock-short"><p>A tree that is modifiable during a transaction.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Tree.html" title="nebari::Tree struct">Tree</a></div><div class="item-right docblock-short"><p>A named collection of keys and values.</p>
</div></div></div><h2 id="enums" class="section-header"><a href="#enums">Enums</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.AbortError.html" title="nebari::AbortError enum">AbortError</a></div><div class="item-right docblock-short"><p>An error that could come from user code or Nebari.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.CompareAndSwapError.html" title="nebari::CompareAndSwapError enum">CompareAndSwapError</a></div><div class="item-right docblock-short"><p>An error returned from <code>compare_and_swap()</code>.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.ErrorKind.html" title="nebari::ErrorKind enum">ErrorKind</a></div><div class="item-right docblock-short"><p>An error from Nebari.</p>
</div></div></div><h2 id="traits" class="section-header"><a href="#traits">Traits</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.Vault.html" title="nebari::Vault trait">Vault</a></div><div class="item-right docblock-short"><p>A provider of encryption for blocks of data.</p>
</div></div></div></section><section id="search" class="content hidden"></section><div id="rustdoc-vars" data-root-path="../" data-current-crate="nebari" data-search-index-js="../search-index.js" data-search-js="../search.js"></div>
    <script src="../main.js"></script>
</body></html>